<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzzer Educativo</title>
    <style>
        :root {
            /* Design system variables */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            
            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            
            /* App specific colors */
            --color-buzzer: #fbbf24;
            --color-buzzer-pressed: #f59e0b;
            --color-danger: #dc2626;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(119, 124, 124, 0.15);
                --color-secondary-hover: rgba(119, 124, 124, 0.25);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(119, 124, 124, 0.2);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
            }
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--space-16);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .header {
            text-align: center;
            margin-bottom: var(--space-32);
        }
        
        .header h1 {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-8);
            color: var(--color-primary);
        }
        
        .header p {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
        }
        
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            box-shadow: var(--shadow-sm);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-16) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 48px;
        }
        
        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }
        
        .btn--primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }
        
        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }
        
        .btn--secondary:hover:not(:disabled) {
            background: var(--color-secondary-hover);
        }
        
        .btn--danger {
            background: var(--color-error);
            color: white;
        }
        
        .btn--success {
            background: var(--color-success);
            color: white;
        }
        
        .btn--warning {
            background: var(--color-warning);
            color: white;
        }
        
        .btn--lg {
            padding: var(--space-20) var(--space-32);
            font-size: var(--font-size-xl);
            min-height: 64px;
        }
        
        .btn--xl {
            padding: var(--space-32);
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            min-height: 120px;
            width: 100%;
        }
        
        .btn--full {
            width: 100%;
            margin-bottom: var(--space-16);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: var(--space-20);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
        }
        
        .form-control {
            width: 100%;
            padding: var(--space-16);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            background: var(--color-surface);
            color: var(--color-text);
            min-height: 48px;
        }
        
        .form-control:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }
        
        .session-code {
            background: var(--color-bg-1);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            text-align: center;
            margin-bottom: var(--space-24);
        }
        
        .session-code h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-8);
        }
        
        .session-code .code {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            letter-spacing: 0.1em;
        }
        
        .students-list {
            margin-bottom: var(--space-24);
        }
        
        .students-list h3 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-16);
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12) var(--space-16);
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-8);
        }
        
        .student-name {
            font-weight: var(--font-weight-medium);
        }
        
        .student-score {
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }
        
        .buzzer-status {
            text-align: center;
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-medium);
        }
        
        .buzzer-status--waiting {
            background: var(--color-bg-3);
            color: var(--color-text-secondary);
        }
        
        .buzzer-status--active {
            background: var(--color-buzzer);
            color: var(--color-black);
            animation: pulse 1s infinite;
        }
        
        .buzzer-status--buzzed {
            background: var(--color-success);
            color: white;
        }
        
        .buzzer-status--finished {
            background: var(--color-bg-4);
            color: var(--color-text-secondary);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .buzzer-btn {
            background: var(--color-buzzer);
            color: var(--color-black);
            border: 4px solid var(--color-buzzer-pressed);
            box-shadow: 0 8px 0 var(--color-buzzer-pressed);
            transition: all 0.1s ease;
            border-radius: var(--radius-lg);
        }
        
        .buzzer-btn:hover:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 6px 0 var(--color-buzzer-pressed);
        }
        
        .buzzer-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--color-buzzer-pressed);
        }
        
        .buzzer-btn:disabled {
            background: var(--color-secondary);
            border-color: var(--color-border);
            box-shadow: 0 8px 0 var(--color-border);
            color: var(--color-text-secondary);
        }
        
        .round-controls {
            text-align: center;
            margin-bottom: var(--space-24);
        }
        
        .timer {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-16);
        }
        
        .buzzer-queue {
            margin-bottom: var(--space-24);
        }
        
        .buzzer-queue h3 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-16);
        }
        
        .buzzer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12) var(--space-16);
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-8);
        }
        
        .buzzer-position {
            background: var(--color-primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
        }
        
        .score-controls {
            display: flex;
            gap: var(--space-8);
        }
        
        .score-btn {
            padding: var(--space-4) var(--space-12);
            font-size: var(--font-size-sm);
            min-height: 32px;
        }
        
        .scoreboard {
            margin-top: var(--space-24);
        }
        
        .scoreboard h3 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-16);
        }
        
        .error-message {
            background: var(--color-bg-4);
            color: var(--color-error);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border: 1px solid var(--color-error);
        }
        
        .success-message {
            background: var(--color-bg-3);
            color: var(--color-success);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border: 1px solid var(--color-success);
        }
        
        .back-btn {
            margin-bottom: var(--space-24);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-12);
            }
            
            .card {
                padding: var(--space-16);
            }
            
            .header h1 {
                font-size: var(--font-size-3xl);
            }
            
            .session-code .code {
                font-size: var(--font-size-3xl);
            }
            
            .score-controls {
                flex-wrap: wrap;
            }
            
            .student-item, .buzzer-item {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-8);
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Pantalla Principal -->
        <div id="home-screen" class="screen active">
            <div class="header">
                <h1>üéØ Buzzer Educativo</h1>
                <p>Sistema interactivo para el aula</p>
            </div>
            
            <div class="card">
                <button class="btn btn--primary btn--lg btn--full" onclick="showCreateSession()">
                    üìö Crear Nueva Sesi√≥n (Profesor)
                </button>
                <button class="btn btn--secondary btn--lg btn--full" onclick="showJoinSession()">
                    üéì Unirse a Sesi√≥n (Alumno)
                </button>
            </div>
        </div>
        
        <!-- Crear Sesi√≥n -->
        <div id="create-session-screen" class="screen">
            <button class="btn btn--secondary back-btn" onclick="showHome()">‚Üê Volver</button>
            
            <div class="header">
                <h1>Crear Nueva Sesi√≥n</h1>
                <p>Genera un c√≥digo para que tus alumnos se unan</p>
            </div>
            
            <div class="card">
                <button class="btn btn--primary btn--lg btn--full" onclick="createSession()">
                    Generar C√≥digo de Sesi√≥n
                </button>
            </div>
        </div>
        
        <!-- Unirse a Sesi√≥n -->
        <div id="join-session-screen" class="screen">
            <button class="btn btn--secondary back-btn" onclick="showHome()">‚Üê Volver</button>
            
            <div class="header">
                <h1>Unirse a Sesi√≥n</h1>
                <p>Introduce el c√≥digo y tu nombre</p>
            </div>
            
            <div class="card">
                <div id="join-error" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label class="form-label" for="session-code-input">C√≥digo de Sesi√≥n</label>
                    <input type="text" id="session-code-input" class="form-control" placeholder="Ej: 123456" maxlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="student-name-input">Tu Nombre</label>
                    <input type="text" id="student-name-input" class="form-control" placeholder="Ej: Ana L√≥pez">
                </div>
                
                <button class="btn btn--primary btn--lg btn--full" onclick="joinSession()">
                    Unirse a la Sesi√≥n
                </button>
            </div>
        </div>
        
        <!-- Vista del Profesor -->
        <div id="teacher-screen" class="screen">
            <button class="btn btn--secondary back-btn" onclick="endSession()">‚Üê Finalizar Sesi√≥n</button>
            
            <div class="session-code">
                <h2>C√≥digo de Sesi√≥n</h2>
                <div class="code" id="session-code-display"></div>
            </div>
            
            <div class="card">
                <div class="students-list">
                    <h3>Alumnos Conectados (<span id="student-count">0</span>)</h3>
                    <div id="students-container"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="round-controls">
                    <div id="timer-display" class="timer" style="display: none;">Tiempo: <span id="timer-value">0</span>s</div>
                    <button id="round-btn" class="btn btn--success btn--lg btn--full" onclick="toggleRound()">
                        INICIAR RONDA
                    </button>
                    <button class="btn btn--secondary btn--full" onclick="clearRound()" style="margin-top: var(--space-8);">
                        Limpiar Ronda
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="buzzer-queue">
                    <h3>Orden de Respuestas</h3>
                    <div id="buzzer-queue-container">
                        <p style="color: var(--color-text-secondary); text-align: center;">Ning√∫n alumno ha presionado el buzzer a√∫n</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="scoreboard">
                    <h3>Puntuaciones</h3>
                    <div id="scoreboard-container">
                        <p style="color: var(--color-text-secondary); text-align: center;">No hay puntuaciones registradas</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista del Alumno -->
        <div id="student-screen" class="screen">
            <button class="btn btn--secondary back-btn" onclick="leaveSession()">‚Üê Salir de la Sesi√≥n</button>
            
            <div class="header">
                <h1>¬°Hola, <span id="student-name-display"></span>!</h1>
                <p>Sesi√≥n: <span id="student-session-display"></span></p>
            </div>
            
            <div class="card">
                <div id="buzzer-status" class="buzzer-status buzzer-status--waiting">
                    Esperando que inicie la ronda...
                </div>
                
                <button id="buzzer-button" class="btn buzzer-btn btn--xl" onclick="pressBuzzer()" disabled>
                    üîî BUZZER
                </button>
                
                <div id="student-position" style="text-align: center; margin-top: var(--space-16); font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); display: none;">
                    Posici√≥n: #<span id="position-number"></span>
                </div>
            </div>
            
            <div class="card">
                <h3>Tu Puntuaci√≥n</h3>
                <div style="text-align: center; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">
                    <span id="student-score-display">0</span> puntos
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBgHLwmcUzb-Y3bK7e8I2z9n6T5oV3xR2Q",
            authDomain: "buzzer-educativo-demo.firebaseapp.com",
            databaseURL: "https://buzzer-educativo-demo-default-rtdb.firebaseio.com",
            projectId: "buzzer-educativo-demo"
        };
        
        // Inicializar Firebase
        let database, sessionRef, studentsRef, roundRef, buzzersRef;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase inicializado correctamente');
        } catch (error) {
            console.error('Error al inicializar Firebase:', error);
            alert('Error de conexi√≥n. Intenta recargar la p√°gina.');
        }
        
        // Estado global de la aplicaci√≥n
        let appState = {
            currentScreen: 'home',
            currentSession: null,
            userType: null, // 'teacher' | 'student'
            studentData: null,
            studentId: null,
            roundTimer: null,
            roundStartTime: null,
            listeners: []
        };
        
        // Utilidades
        function generateSessionCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function generateStudentId() {
            return 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function cleanupListeners() {
            appState.listeners.forEach(listener => {
                if (listener.off) listener.off();
            });
            appState.listeners = [];
        }
        
        async function checkSessionExists(sessionCode) {
            try {
                const snapshot = await database.ref(`sessions/${sessionCode}`).once('value');
                return snapshot.exists();
            } catch (error) {
                console.error('Error checking session:', error);
                return false;
            }
        }
        
        function getCurrentTime() {
            return Date.now();
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            appState.currentScreen = screenId;
        }
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        // Navegaci√≥n
        function showHome() {
            cleanupListeners();
            if (appState.roundTimer) {
                clearInterval(appState.roundTimer);
                appState.roundTimer = null;
            }
            showScreen('home-screen');
            appState.userType = null;
            appState.currentSession = null;
            appState.studentData = null;
            appState.studentId = null;
        }
        
        function showCreateSession() {
            showScreen('create-session-screen');
        }
        
        function showJoinSession() {
            showScreen('join-session-screen');
            document.getElementById('session-code-input').value = '';
            document.getElementById('student-name-input').value = '';
        }
        
        // Funciones del Profesor
        async function createSession() {
            try {
                const sessionCode = generateSessionCode();
                const sessionData = {
                    info: {
                        teacherName: 'Profesor',
                        created: firebase.database.ServerValue.TIMESTAMP,
                        state: 'waiting'
                    },
                    currentRound: {
                        active: false,
                        startTime: null
                    }
                };
                
                await database.ref(`sessions/${sessionCode}`).set(sessionData);
                
                appState.currentSession = sessionCode;
                appState.userType = 'teacher';
                
                document.getElementById('session-code-display').textContent = sessionCode;
                showScreen('teacher-screen');
                setupTeacherListeners();
                updateTeacherView();
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Error al crear la sesi√≥n. Intenta de nuevo.');
            }
        }
        
        function setupTeacherListeners() {
            if (!appState.currentSession) return;
            
            const sessionCode = appState.currentSession;
            
            // Listener para estudiantes
            const studentsListener = database.ref(`sessions/${sessionCode}/students`).on('value', (snapshot) => {
                updateStudentsList(snapshot.val());
            });
            
            // Listener para buzzers
            const buzzersListener = database.ref(`sessions/${sessionCode}/currentRound/buzzers`).on('value', (snapshot) => {
                updateBuzzerQueue(snapshot.val());
            });
            
            // Listener para estado de la ronda
            const roundListener = database.ref(`sessions/${sessionCode}/currentRound`).on('value', (snapshot) => {
                const roundData = snapshot.val();
                updateRoundButton(roundData ? roundData.active : false);
            });
            
            appState.listeners.push(
                { off: () => database.ref(`sessions/${sessionCode}/students`).off('value', studentsListener) },
                { off: () => database.ref(`sessions/${sessionCode}/currentRound/buzzers`).off('value', buzzersListener) },
                { off: () => database.ref(`sessions/${sessionCode}/currentRound`).off('value', roundListener) }
            );
        }
        
        function updateStudentsList(studentsData) {
            const studentsContainer = document.getElementById('students-container');
            
            if (!studentsData) {
                document.getElementById('student-count').textContent = '0';
                studentsContainer.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No hay alumnos conectados</p>';
                return;
            }
            
            const students = Object.values(studentsData);
            document.getElementById('student-count').textContent = students.length;
            
            studentsContainer.innerHTML = students.map(student => `
                <div class="student-item">
                    <span class="student-name">${student.name}</span>
                    <span class="student-score">${student.score || 0} pts</span>
                </div>
            `).join('');
            
            updateScoreboard(studentsData);
        }
        
        function updateRoundButton(isActive) {
            const roundBtn = document.getElementById('round-btn');
            if (isActive) {
                roundBtn.textContent = 'FINALIZAR RONDA';
                roundBtn.className = 'btn btn--danger btn--lg btn--full';
            } else {
                roundBtn.textContent = 'INICIAR RONDA';
                roundBtn.className = 'btn btn--success btn--lg btn--full';
            }
        }
        
        function updateTeacherView() {
            // Esta funci√≥n ahora es manejada por los listeners
        }
        
        async function toggleRound() {
            if (!appState.currentSession) return;
            
            try {
                const sessionCode = appState.currentSession;
                const roundRef = database.ref(`sessions/${sessionCode}/currentRound`);
                const roundSnapshot = await roundRef.once('value');
                const roundData = roundSnapshot.val() || {};
                
                if (!roundData.active) {
                    // Iniciar ronda
                    await roundRef.update({
                        active: true,
                        startTime: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Limpiar buzzers anteriores
                    await database.ref(`sessions/${sessionCode}/currentRound/buzzers`).remove();
                    
                    // Iniciar timer
                    let seconds = 0;
                    const timerDisplay = document.getElementById('timer-display');
                    const timerValue = document.getElementById('timer-value');
                    timerDisplay.style.display = 'block';
                    
                    appState.roundTimer = setInterval(() => {
                        seconds++;
                        timerValue.textContent = seconds;
                    }, 1000);
                    
                } else {
                    // Finalizar ronda
                    await roundRef.update({
                        active: false
                    });
                    
                    // Detener timer
                    if (appState.roundTimer) {
                        clearInterval(appState.roundTimer);
                        appState.roundTimer = null;
                    }
                    
                    document.getElementById('timer-display').style.display = 'none';
                }
            } catch (error) {
                console.error('Error toggling round:', error);
                alert('Error al cambiar el estado de la ronda.');
            }
        }
        
        async function clearRound() {
            if (!appState.currentSession) return;
            
            try {
                const sessionCode = appState.currentSession;
                await database.ref(`sessions/${sessionCode}/currentRound/buzzers`).remove();
            } catch (error) {
                console.error('Error clearing round:', error);
                alert('Error al limpiar la ronda.');
            }
        }
        
        function updateBuzzerQueue(buzzersData) {
            const container = document.getElementById('buzzer-queue-container');
            
            if (!buzzersData) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">Ning√∫n alumno ha presionado el buzzer a√∫n</p>';
                return;
            }
            
            // Convertir a array y ordenar por timestamp
            const buzzers = Object.values(buzzersData).sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = buzzers.map((buzzer, index) => `
                <div class="buzzer-item">
                    <div style="display: flex; align-items: center; gap: var(--space-12);">
                        <div class="buzzer-position">${index + 1}</div>
                        <span>${buzzer.studentName}</span>
                    </div>
                    <div class="score-controls">
                        <button class="btn btn--success score-btn" onclick="addScore('${buzzer.studentId}', 1)">+1</button>
                        <button class="btn btn--success score-btn" onclick="addScore('${buzzer.studentId}', 2)">+2</button>
                        <button class="btn btn--success score-btn" onclick="addScore('${buzzer.studentId}', 3)">+3</button>
                        <button class="btn btn--danger score-btn" onclick="addScore('${buzzer.studentId}', -1)">-1</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function addScore(studentId, points) {
            if (!appState.currentSession) return;
            
            try {
                const sessionCode = appState.currentSession;
                const studentRef = database.ref(`sessions/${sessionCode}/students/${studentId}`);
                const snapshot = await studentRef.once('value');
                const studentData = snapshot.val();
                
                if (studentData) {
                    const currentScore = studentData.score || 0;
                    const newScore = Math.max(0, currentScore + points);
                    await studentRef.update({ score: newScore });
                }
            } catch (error) {
                console.error('Error adding score:', error);
                alert('Error al actualizar la puntuaci√≥n.');
            }
        }
        
        function updateScoreboard(studentsData) {
            const container = document.getElementById('scoreboard-container');
            
            if (!studentsData) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No hay puntuaciones registradas</p>';
                return;
            }
            
            const students = Object.values(studentsData)
                .sort((a, b) => (b.score || 0) - (a.score || 0))
                .filter(student => (student.score || 0) > 0);
            
            if (students.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No hay puntuaciones registradas</p>';
            } else {
                container.innerHTML = students.map((student, index) => `
                    <div class="student-item">
                        <span class="student-name">
                            ${index === 0 ? 'ü•á ' : index === 1 ? 'ü•à ' : index === 2 ? 'ü•â ' : ''}
                            ${student.name}
                        </span>
                        <span class="student-score">${student.score || 0} pts</span>
                    </div>
                `).join('');
            }
        }
        
        async function endSession() {
            if (confirm('¬øEst√°s seguro de que quieres finalizar la sesi√≥n?')) {
                if (appState.roundTimer) {
                    clearInterval(appState.roundTimer);
                    appState.roundTimer = null;
                }
                
                try {
                    if (appState.currentSession) {
                        await database.ref(`sessions/${appState.currentSession}`).remove();
                    }
                } catch (error) {
                    console.error('Error ending session:', error);
                }
                
                showHome();
            }
        }
        
        // Funciones del Alumno
        async function joinSession() {
            const sessionCode = document.getElementById('session-code-input').value.trim();
            const studentName = document.getElementById('student-name-input').value.trim();
            
            if (!sessionCode) {
                showError('join-error', 'Por favor, introduce el c√≥digo de sesi√≥n');
                return;
            }
            
            if (!studentName) {
                showError('join-error', 'Por favor, introduce tu nombre');
                return;
            }
            
            try {
                // Verificar que la sesi√≥n existe
                const sessionExists = await checkSessionExists(sessionCode);
                if (!sessionExists) {
                    showError('join-error', 'C√≥digo de sesi√≥n no v√°lido');
                    return;
                }
                
                // Verificar si el nombre ya est√° en uso
                const studentsSnapshot = await database.ref(`sessions/${sessionCode}/students`).once('value');
                const studentsData = studentsSnapshot.val() || {};
                const studentExists = Object.values(studentsData).some(student => student.name === studentName);
                
                if (studentExists) {
                    showError('join-error', 'Ya hay un alumno con ese nombre en la sesi√≥n');
                    return;
                }
                
                // Generar ID √∫nico para el estudiante
                const studentId = generateStudentId();
                
                // Agregar alumno a la sesi√≥n
                const studentData = {
                    name: studentName,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    score: 0,
                    connected: true
                };
                
                await database.ref(`sessions/${sessionCode}/students/${studentId}`).set(studentData);
                
                appState.currentSession = sessionCode;
                appState.userType = 'student';
                appState.studentData = studentData;
                appState.studentId = studentId;
                
                document.getElementById('student-name-display').textContent = studentName;
                document.getElementById('student-session-display').textContent = sessionCode;
                
                showScreen('student-screen');
                setupStudentListeners();
                
                // Configurar desconexi√≥n autom√°tica
                database.ref(`sessions/${sessionCode}/students/${studentId}/connected`).onDisconnect().set(false);
                
            } catch (error) {
                console.error('Error joining session:', error);
                showError('join-error', 'Error al unirse a la sesi√≥n. Verifica el c√≥digo.');
            }
        }
        
        function setupStudentListeners() {
            if (!appState.currentSession || !appState.studentId) return;
            
            const sessionCode = appState.currentSession;
            const studentId = appState.studentId;
            
            // Listener para el estado de la ronda
            const roundListener = database.ref(`sessions/${sessionCode}/currentRound`).on('value', (snapshot) => {
                const roundData = snapshot.val() || {};
                updateStudentBuzzerState(roundData.active || false);
            });
            
            // Listener para la puntuaci√≥n del estudiante
            const scoreListener = database.ref(`sessions/${sessionCode}/students/${studentId}/score`).on('value', (snapshot) => {
                const score = snapshot.val() || 0;
                document.getElementById('student-score-display').textContent = score;
            });
            
            // Listener para buzzers (para mostrar posici√≥n)
            const buzzersListener = database.ref(`sessions/${sessionCode}/currentRound/buzzers`).on('value', (snapshot) => {
                const buzzersData = snapshot.val() || {};
                updateStudentPosition(buzzersData);
            });
            
            appState.listeners.push(
                { off: () => database.ref(`sessions/${sessionCode}/currentRound`).off('value', roundListener) },
                { off: () => database.ref(`sessions/${sessionCode}/students/${studentId}/score`).off('value', scoreListener) },
                { off: () => database.ref(`sessions/${sessionCode}/currentRound/buzzers`).off('value', buzzersListener) }
            );
        }
        
        function updateStudentBuzzerState(isRoundActive) {
            const buzzerStatus = document.getElementById('buzzer-status');
            const buzzerButton = document.getElementById('buzzer-button');
            const studentPosition = document.getElementById('student-position');
            
            if (!isRoundActive) {
                buzzerStatus.textContent = 'Esperando que inicie la ronda...';
                buzzerStatus.className = 'buzzer-status buzzer-status--waiting';
                buzzerButton.disabled = true;
                studentPosition.style.display = 'none';
                appState.hasBuzzed = false;
            } else {
                if (appState.hasBuzzed) {
                    buzzerStatus.textContent = '¬°Buzzer presionado!';
                    buzzerStatus.className = 'buzzer-status buzzer-status--buzzed';
                    buzzerButton.disabled = true;
                } else {
                    buzzerStatus.textContent = '¬°PRESIONA EL BUZZER PARA RESPONDER!';
                    buzzerStatus.className = 'buzzer-status buzzer-status--active';
                    buzzerButton.disabled = false;
                    studentPosition.style.display = 'none';
                }
            }
        }
        
        function updateStudentPosition(buzzersData) {
            if (!appState.studentId || !buzzersData) return;
            
            // Buscar mi buzzer en la lista
            const myBuzzer = Object.values(buzzersData).find(buzzer => buzzer.studentId === appState.studentId);
            
            if (myBuzzer) {
                // Ordenar por timestamp para obtener la posici√≥n correcta
                const sortedBuzzers = Object.values(buzzersData).sort((a, b) => a.timestamp - b.timestamp);
                const position = sortedBuzzers.findIndex(buzzer => buzzer.studentId === appState.studentId) + 1;
                
                document.getElementById('position-number').textContent = position;
                document.getElementById('student-position').style.display = 'block';
            }
        }
        
        async function pressBuzzer() {
            if (!appState.currentSession || !appState.studentId || appState.hasBuzzed) return;
            
            try {
                const sessionCode = appState.currentSession;
                const studentId = appState.studentId;
                const studentName = appState.studentData.name;
                
                // Verificar que la ronda est√© activa
                const roundSnapshot = await database.ref(`sessions/${sessionCode}/currentRound/active`).once('value');
                if (!roundSnapshot.val()) {
                    return;
                }
                
                // Registrar el buzzer con timestamp del servidor
                const buzzerData = {
                    studentId: studentId,
                    studentName: studentName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                const buzzerRef = database.ref(`sessions/${sessionCode}/currentRound/buzzers`).push();
                await buzzerRef.set(buzzerData);
                
                appState.hasBuzzed = true;
                
                // Actualizar UI inmediatamente
                const buzzerStatus = document.getElementById('buzzer-status');
                const buzzerButton = document.getElementById('buzzer-button');
                
                buzzerStatus.textContent = '¬°Buzzer presionado!';
                buzzerStatus.className = 'buzzer-status buzzer-status--buzzed';
                buzzerButton.disabled = true;
                
            } catch (error) {
                console.error('Error pressing buzzer:', error);
                alert('Error al presionar el buzzer. Intenta de nuevo.');
            }
        }
        
        async function leaveSession() {
            if (confirm('¬øEst√°s seguro de que quieres salir de la sesi√≥n?')) {
                try {
                    if (appState.currentSession && appState.studentId) {
                        await database.ref(`sessions/${appState.currentSession}/students/${appState.studentId}`).remove();
                    }
                } catch (error) {
                    console.error('Error leaving session:', error);
                }
                
                showHome();
            }
        }
        
        // Limpiar intervalos y listeners al cambiar de p√°gina
        window.addEventListener('beforeunload', () => {
            if (appState.roundTimer) {
                clearInterval(appState.roundTimer);
            }
            cleanupListeners();
        });
        
        // Manejo de teclas para facilidad de uso
        document.addEventListener('keydown', (e) => {
            if (appState.userType === 'student' && e.code === 'Space' && appState.currentScreen === 'student-screen') {
                e.preventDefault();
                const buzzerButton = document.getElementById('buzzer-button');
                if (!buzzerButton.disabled) {
                    pressBuzzer();
                }
            }
        });
        
        // Funci√≥n para manejar errores de conexi√≥n
        function handleConnectionError() {
            alert('Error de conexi√≥n con la base de datos. Verifica tu conexi√≥n a internet e intenta de nuevo.');
        }
        
        // Detectar si estamos offline
        window.addEventListener('online', () => {
            console.log('Conexi√≥n restaurada');
        });
        
        window.addEventListener('offline', () => {
            alert('Conexi√≥n perdida. Algunas funciones pueden no estar disponibles.');
        });
    </script>
</body>
</html>